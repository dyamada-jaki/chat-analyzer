name: ğŸ§ª CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
  backend-test:
    name: ğŸ”§ Backend Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: backend/pnpm-lock.yaml
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    - name: ğŸ“š Install dependencies
      working-directory: ./backend
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ—ï¸ Build backend
      working-directory: ./backend
      run: pnpm build
      
    - name: ğŸ§ª Run tests
      working-directory: ./backend
      run: pnpm test --run
      
    - name: ğŸ“Š Upload coverage reports
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v4
      with:
        directory: ./backend
        fail_ci_if_error: false

  # Chromeæ‹¡å¼µæ©Ÿèƒ½ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
  chrome-extension-build:
    name: ğŸŒ Chrome Extension Build
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âœ… Validate manifest.json
      working-directory: ./chrome-extension
      run: |
        # manifest.jsonã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        node -e "JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'))"
        echo "âœ… manifest.json is valid"
        
    - name: ğŸ” Check required files
      working-directory: ./chrome-extension
      run: |
        # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        files=("manifest.json" "content.js" "content.css" "popup.html" "popup.js" "background.js")
        for file in "${files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ Missing required file: $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        
    - name: ğŸ“ Check file sizes
      working-directory: ./chrome-extension
      run: |
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆChrome Web Storeåˆ¶é™ï¼‰
        max_size=20971520  # 20MB
        for file in *.js *.css *.html; do
          if [ -f "$file" ]; then
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
            if [ $size -gt $max_size ]; then
              echo "âŒ File too large: $file ($size bytes > $max_size bytes)"
              exit 1
            else
              echo "âœ… Size OK: $file ($size bytes)"
            fi
          fi
        done

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  security-audit:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    - name: ğŸ” Security audit
      working-directory: ./backend
      run: |
        pnpm install --frozen-lockfile
        pnpm audit --audit-level moderate
        
    - name: ğŸ” Check for secrets
      run: |
        # æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©ãƒã‚§ãƒƒã‚¯
        if grep -r -i "api[_-]key\|secret\|password\|token" --include="*.js" --include="*.ts" --include="*.json" . | grep -v node_modules | grep -v ".git" | grep -v "test" | grep -v "example"; then
          echo "âŒ Potential secrets found in code"
          exit 1
        else
          echo "âœ… No secrets detected"
        fi

  # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œè¨¼
  docs-validation:
    name: ğŸ“š Documentation Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âœ… Check README.md
      run: |
        if [ ! -f "README.md" ]; then
          echo "âŒ README.md is missing"
          exit 1
        fi
        
        # README.mdã®åŸºæœ¬æ§‹é€ ãƒã‚§ãƒƒã‚¯
        required_sections=("# " "## " "### ")
        for section in "${required_sections[@]}"; do
          if ! grep -q "^$section" README.md; then
            echo "âŒ README.md missing proper headings"
            exit 1
          fi
        done
        echo "âœ… README.md structure is valid"
        
    - name: ğŸ“‹ Validate package.json
      working-directory: ./backend
      run: |
        # package.jsonã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
        node -e "
          const pkg = JSON.parse(require('fs').readFileSync('package.json', 'utf8'));
          const required = ['name', 'version', 'scripts'];
          for (const field of required) {
            if (!pkg[field]) {
              console.error(\`âŒ Missing required field: \${field}\`);
              process.exit(1);
            }
          }
          console.log('âœ… package.json is valid');
        "

  # çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†é€šçŸ¥
  integration-complete:
    name: âœ… Integration Complete
    runs-on: ubuntu-latest
    needs: [backend-test, chrome-extension-build, security-audit, docs-validation]
    
    steps:
    - name: ğŸ‰ All checks passed
      run: |
        echo "ğŸ‰ All CI/CD checks completed successfully!"
        echo "âœ… Backend tests: PASSED"
        echo "âœ… Chrome extension build: PASSED"  
        echo "âœ… Security audit: PASSED"
        echo "âœ… Documentation: PASSED"
        echo ""
        echo "ğŸš€ Ready for deployment!"
