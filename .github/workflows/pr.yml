name: ğŸ” Pull Request Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  # PRæƒ…å ±æ¤œè¨¼
  pr-validation:
    name: ğŸ“‹ PR Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“Š PR Stats
      run: |
        echo "ğŸ“‹ Pull Request Information:"
        echo "Title: ${{ github.event.pull_request.title }}"
        echo "Author: ${{ github.event.pull_request.user.login }}"
        echo "Base: ${{ github.event.pull_request.base.ref }}"
        echo "Head: ${{ github.event.pull_request.head.ref }}"
        echo ""
        
        # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | wc -l)
        echo "ğŸ“ Changed files: $changed_files"
        
        # å¤‰æ›´è¡Œæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        additions=$(git diff --numstat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | awk '{sum += $1} END {print sum}')
        deletions=$(git diff --numstat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | awk '{sum += $2} END {print sum}')
        echo "â• Additions: ${additions:-0}"
        echo "â– Deletions: ${deletions:-0}"

  # å¤‰æ›´å·®åˆ†ãƒ†ã‚¹ãƒˆ
  diff-tests:
    name: ğŸ”¬ Differential Testing
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: latest
        
    - name: ğŸ§ª Run tests on changed backend files
      run: |
        # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -q "^backend/"; then
          echo "ğŸ”§ Backend files changed, running tests..."
          cd backend
          pnpm install --frozen-lockfile
          pnpm test --run
        else
          echo "â„¹ï¸ No backend changes detected, skipping backend tests"
        fi
        
    - name: ğŸŒ Validate Chrome extension changes
      run: |
        # Chromeæ‹¡å¼µæ©Ÿèƒ½ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®æ¤œè¨¼
        if git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep -q "^chrome-extension/"; then
          echo "ğŸŒ Chrome extension files changed, validating..."
          cd chrome-extension
          
          # manifest.jsonã®æ¤œè¨¼
          if [ -f "manifest.json" ]; then
            node -e "JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'))"
            echo "âœ… manifest.json is valid"
          fi
          
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          required_files=("content.js" "popup.js" "background.js")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
        else
          echo "â„¹ï¸ No Chrome extension changes detected"
        fi

  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“Š Code complexity analysis
      run: |
        echo "ğŸ“Š Analyzing code complexity..."
        
        # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®è¡Œæ•°ãƒã‚§ãƒƒã‚¯
        find . -name "*.js" -not -path "./node_modules/*" -not -path "./.git/*" | while read file; do
          lines=$(wc -l < "$file")
          if [ $lines -gt 500 ]; then
            echo "âš ï¸ Large file detected: $file ($lines lines)"
          else
            echo "âœ… $file ($lines lines)"
          fi
        done
        
        # TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã®è¡Œæ•°ãƒã‚§ãƒƒã‚¯  
        find . -name "*.ts" -not -path "./node_modules/*" -not -path "./.git/*" | while read file; do
          lines=$(wc -l < "$file")
          if [ $lines -gt 500 ]; then
            echo "âš ï¸ Large file detected: $file ($lines lines)"
          else
            echo "âœ… $file ($lines lines)"
          fi
        done

  # PRè‡ªå‹•ãƒ©ãƒ™ãƒ«
  auto-label:
    name: ğŸ·ï¸ Auto Label
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ·ï¸ Add labels based on changes
      uses: actions/github-script@v7
      with:
        script: |
          const { context } = require('@actions/github');
          const { execSync } = require('child_process');
          
          // å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          const changedFiles = execSync(
            `git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}`,
            { encoding: 'utf8' }
          ).split('\n').filter(Boolean);
          
          const labels = [];
          
          // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åŸºã¥ã„ã¦ãƒ©ãƒ™ãƒ«ã‚’æ±ºå®š
          if (changedFiles.some(file => file.startsWith('backend/'))) {
            labels.push('backend');
          }
          if (changedFiles.some(file => file.startsWith('chrome-extension/'))) {
            labels.push('chrome-extension');
          }
          if (changedFiles.some(file => file.includes('test'))) {
            labels.push('tests');
          }
          if (changedFiles.some(file => file.endsWith('.md'))) {
            labels.push('documentation');
          }
          if (changedFiles.some(file => file.includes('.github/workflows'))) {
            labels.push('ci/cd');
          }
          
          // ã‚µã‚¤ã‚ºã«åŸºã¥ããƒ©ãƒ™ãƒ«
          const totalChanges = changedFiles.length;
          if (totalChanges > 20) {
            labels.push('size/large');
          } else if (totalChanges > 5) {
            labels.push('size/medium');
          } else {
            labels.push('size/small');
          }
          
          // ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels
            });
            
            console.log(`Added labels: ${labels.join(', ')}`);
          }
